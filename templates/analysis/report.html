{% extends 'base.html' %}

{% block title %}
{% if platform == 'chess.com' %}
Chess.com Analysis Report for {{ username }} - Chess Analysis
{% else %}
Lichess Analysis Report for {{ username }} - Chess Analysis
{% endif %}
{% endblock %}

{% block content %}
<div class="simple-report">
    {% load static %}
    <div class="report-header" style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
        {% if platform == 'chess.com' %}
            <img src="{% static 'images/chess_com_logo.png' %}" alt="Chess.com" style="height: 40px; width: auto;">
            <h1>Chess.com Analysis Report for {{ username }}</h1>
        {% else %}
            <img src="{% static 'images/lichess_logo.svg' %}" alt="Lichess" style="height: 40px; width: auto;">
            <h1>Lichess Analysis Report for {{ username }}</h1>
        {% endif %}
    </div>

    {% if auto_start %}
    <!-- Analysis Progress Section -->
    <div id="analysis-progress" style="margin: 20px 0; padding: 20px; border-left: 4px solid #007bff;">
        <h2>ðŸ”„ Analysis Progress</h2>
        <div id="progress-status">Initializing analysis...</div>
        <div id="progress-bar" style="background: #e0e0e0; height: 20px; border-radius: 10px; margin: 10px 0;">
            <div id="progress-fill" style="background: #007bff; height: 100%; width: 0%; border-radius: 10px; transition: width 0.3s;"></div>
        </div>
    </div>
    {% endif %}

    <h2>Raw Game Data (All Games):</h2>
    <pre style="background: #222; color: #fff; padding: 20px; overflow: auto; max-height: 400px;">{{ all_games_raw|safe }}</pre>

    <h2>Enriched Games Data:</h2>
    <pre id="enriched-games" style="background: #2d1b69; color: #fff; padding: 20px; overflow: auto; max-height: 600px;">{{ enriched_games|safe }}</pre>
</div>

<script>
let eventSource;

function startStreaming() {
    const username = "{{ username }}";

    document.getElementById('progress-status').innerText = 'Connecting to analysis monitor...';

    // Start Server-Sent Events to monitor background task
    const platform = "{{ platform|default:'lichess' }}";
    const datasetId = "{{ dataset_id }}";
    const streamUrl = `/stream-analysis/${username}/${datasetId}/`;

    eventSource = new EventSource(streamUrl);

    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        handleAnalysisUpdate(data);
    };

    eventSource.onerror = function(event) {
        console.error('SSE error:', event);
        document.getElementById('progress-status').innerText = 'Error: Connection lost';
    };
}

// Auto-start if flag is set
document.addEventListener('DOMContentLoaded', function() {
    {% if auto_start %}
    startStreaming();
    {% endif %}
});

function handleAnalysisUpdate(data) {
    const progressStatus = document.getElementById('progress-status');
    const progressFill = document.getElementById('progress-fill');

    switch (data.type) {
        case 'init':
            if (data.task_status) {
                // From task monitoring
                progressStatus.innerText = `Task started - ${data.task_status}`;
            } else if (data.message) {
                // From streaming analysis
                progressStatus.innerText = data.message;
            } else {
                // Fallback
                const totalPositions = data.total_positions || 0;
                progressStatus.innerText = `Found ${totalPositions} positions to evaluate`;
            }
            break;

        case 'api_progress':
            const completed = data.completed_calls || 0;
            const total = data.total_calls || 1;
            const progress = Math.round((completed / total) * 100);

            progressFill.style.width = progress + '%';
            progressStatus.innerText = `${data.current_phase} - ${progress}% (${completed}/${total})`;
            break;


        case 'complete':
            progressStatus.innerText = `âœ… Analysis complete! Report saved to database.`;
            progressFill.style.width = '100%';

            if (data.summary) {
                updateDisplaysWithResults(data);
            }

            if (eventSource) {
                eventSource.close();
            }
            break;

        case 'error':
            progressStatus.innerText = `âŒ Error: ${data.error}`;
            if (eventSource) {
                eventSource.close();
            }
            break;
    }
}

function updateDisplaysWithResults(data) {
    // Fetch the actual enriched games data from the completed report
    fetchEnrichedGamesData(data.report_id);
}

function fetchEnrichedGamesData(reportId) {
    // Make a request to get the enriched games data from the completed report
    fetch(`/report-data/${reportId}/`)
        .then(response => response.json())
        .then(data => {
            const enrichedGamesEl = document.getElementById('enriched-games');
            if (data.enriched_games && data.enriched_games.length > 0) {
                enrichedGamesEl.textContent = JSON.stringify(data.enriched_games, null, 2);
            } else {
                enrichedGamesEl.textContent = JSON.stringify({
                    status: "No enriched games data available",
                    report_id: reportId
                }, null, 2);
            }
        })
        .catch(error => {
            console.error('Error fetching enriched games:', error);
            const enrichedGamesEl = document.getElementById('enriched-games');
            enrichedGamesEl.textContent = JSON.stringify({
                error: "Failed to load enriched games data",
                details: error.message
            }, null, 2);
        });
}

</script>

{% load static %}
<script src="{% static 'js/dist/main.js' %}"></script>
{% endblock %}